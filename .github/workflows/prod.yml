name: Build and Deploy Salesforce Package

on:
  push:
    branches:
      - prod 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Get your code from the repository 
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Install the Salesforce CLI
      - name: Install Salesforce CLI
        uses: salesforce/setup-sf@v1
 
      # # 3. Authenticate to the Dev Hub (where packages are created)
      # # Uses the SF_DEV_HUB_AUTH_URL secret you created
      # - name: Authenticate to Dev Hub
      #   run: |
      #     echo "${{ secrets.SF_DEV_HUB_AUTH_URL }}" > ./devhub-auth.txt
      #     sf org login sfdx-url --sfdx-url-file ./devhub-auth.txt --set-default-dev-hub

      # 4. Authenticate to the Production Org (where package is installed)
      # Uses the SF_PROD_AUTH_URL secret
      - name: Authenticate to Production Org
        run: |
          echo "${{ secrets.SF_PROD_AUTH_URL }}" > ./prod-auth.txt
          sf org login sfdx-url --sfdx-url-file ./prod-auth.txt --alias prodOrg

      # 5. Create a new package version
      # - Uses the manual 'package_name' input
      # - Uses the PACKAGE_INSTALL_KEY secret
      # - Waits for 15 minutes (you can adjust this)
      # - Stores the new 04t... ID in an environment variable
      - name: Create New Package Version
        run: |
          # This is now hardcoded to 'serverobjectpackage'
          echo "Creating new version for package: serverobjectpackage"
          
          # This command outputs JSON, which we then parse to find the SubscriberPackageVersionId (04t...)
          JSON_OUTPUT=$(sf package version create --package "serverobjectpackage" --installation-key "${{ secrets.PACKAGE_INSTALL_KEY }}" --wait 15 --json)
          
          echo $JSON_OUTPUT
          
          PACKAGE_VERSION_ID=$(echo $JSON_OUTPUT | jq -r .result.SubscriberPackageVersionId)
          
          if [ -z "$PACKAGE_VERSION_ID" ] || [ "$PACKAGE_VERSION_ID" == "null" ]; then
            echo "Failed to create package version. Aborting."
            exit 1
          fi
          
          echo "New Package Version ID: $PACKAGE_VERSION_ID"
          echo "PACKAGE_VERSION_ID=$PACKAGE_VERSION_ID" >> $GITHUB_ENV

      # 6. Promote the new version to "Released"
      # This is best practice before installing in production
      - name: Promote Package Version
        run: |
          echo "Promoting package version: ${{ env.PACKAGE_VERSION_ID }}"
          sf package version promote --package "${{ env.PACKAGE_VERSION_ID }}" --no-prompt

      # 7. Install the new version into Production
      # This is the final deployment step
      - name: Install Package in Production
        run: |
          echo "Installing package version: ${{ env.PACKAGE_VERSION_ID }} into prodOrg"
          sf package install --package "${{ env.PACKAGE_VERSION_ID }}" --target-org prodOrg --installation-key "${{ secrets.PACKAGE_INSTALL_KEY }}" --wait 10 --publish-wait 10